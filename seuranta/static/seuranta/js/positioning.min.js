/* positioning.js by Raphael Stefanini */
var IntValCodec=(function(){var a=function(j){var g=j.length,h=0,f=0,e=0,d=32;while(d>=32&&h<g){d=j.charCodeAt(h)-63;h+=1;e|=(d&31)<<f;f+=5}if(e&1){return[~(e>>>1),j.slice(h)]}else{return[e>>>1,j.slice(h)]}},b=function(d){var e="";while(d>=32){e+=String.fromCharCode((32|(d&31))+63);d=d>>>5}e+=String.fromCharCode((d+63));return e},c=function(d){var e=d*Math.pow(2,1);if(d<0){e=~(e)}return b(e)};return{encodeSignedNumber:c,decodeValueFromString:a}})(),Coordinates=function(a){this.latitude=a.latitude;this.longitude=a.longitude;this.accuracy=a.accuracy;this.distance=function(g){var f=Math.PI/180,d=this.latitude-g.latitude,e=this.longitude-g.longitude,b=Math.pow(Math.sin(f*d/2),2)+Math.cos(f*this.latitude)*Math.cos(f*g.latitude)*Math.pow(Math.sin(f*e/2),2);return 12756274*Math.atan2(Math.sqrt(b),Math.sqrt(1-b))};this.distanceAccuracy=function(b){return this.accuracy+b.accurracy}},Position=function(a){this.timestamp=a.timestamp;this.coords=new Coordinates(a.coords);this.distance=function(b){return this.coords.distance(b.coords)};this.distanceAccuracy=function(b){return this.coords.distanceAccuracy(b.coords)};this.speed=function(b){return this.distance(b)/Math.abs(this.timestamp-b.timestamp)};this.positionTowardAtTimestamp=function(f,e){var h=this,g=h.coords,c=f.coords,d=(e-h.timestamp)/(f.timestamp-h.timestamp),b=1-d;return new Position({timestamp:e,coords:{latitude:c.latitude*d+b*g.latitude,longitude:c.longitude*d+b*g.longitude,accuracy:c.accuracy*d+b*g.accuracy}})}},PositionArchive=function(){var b=[],a=function(e,f,d){f=typeof(f)!=="undefined"?f:0;d=typeof(d)!=="undefined"?d:(b.length-1);var c=Math.floor(f+(d-f)/2);if(d-f<0){return f}if(b[f].timestamp>=e.timestamp){return f}if(b[d].timestamp<=e.timestamp){return d+1}if(b[c].timestamp==e.timestamp){return c}if(d-f<=1){return f+1}if(e.timestamp>b[c].timestamp){return a(e,c,d)}else{return a(e,f,c-1)}};this.add=function(d){if(d.timestamp===null){return}var c=a(d);if(b.length>0&&c<b.length&&b[c].timestamp==d.timestamp){b[c]=d}else{if(b.length>0&&c>=b.length&&b[b.length-1].timestamp==d.timestamp){b[b.length-1]=d}else{b.splice(c,0,d)}}return this};this.eraseInterval=function(f,c){var d=a({timestamp:f}),e=a({timestamp:c});while(d>0&&b[d-1].timestamp>=f){d--}while(e<b.length-1&&b[e].timestamp<=c){e++}b.splice(d,e-d+1);return this};this.getByIndex=function(c){return b[c]};this.getPositionsCount=function(){return b.length};this.getArray=function(){return b};this.getByTime=function(d){var c=a({timestamp:d});if(c===0){return b[0]}if(c>b.length-1){return b[b.length-1]}if(b[c].timestamp==d){return b[c]}else{return b[c-1].positionTowardAtTimestamp(b[c],d)}};this.extractInterval=function(j,g){var d=a({timestamp:j}),h,f,e,c=new PositionArchive();if(d===0){h=0}else{if(d>b.length-1){h=b.length-1}else{if(b[d].timestamp==j){h=d}else{c.add(b[d-1].positionTowardAtTimestamp(b[d],j));h=d}}}d=a({timestamp:g});if(d===0){f=0}else{if(d>b.length-1){f=b.length-1}else{if(b[d].timestamp==g){f=d}else{c.add(b[d-1].positionTowardAtTimestamp(b[d],g));f=d-1}}}for(e=h;e<=f;e++){c.add(b[e])}return c};this.getDuration=function(){if(b.length<=1){return 0}else{return b[b.length-1].timestamp-b[0].timestamp}};this.getAge=function(c){c=c===null?(+new Date()):c;if(b.length===0){return 0}else{return c-b[0].timestamp}};this.exportCSV=function(){var f="timestamp, latitude, longitude, accuracy\n",c,e,d;for(d=0;d<b.length;d++){c=b[d];e=c.coords;f+=[c.timestamp,e.latitude,e.longitude,e.accuracy].join(", ");f+="\n"}return f};this.exportTks=function(){if(b.length===0){return""}var q=Date.parse("2000-01-01T00:00:00Z"),g=new Position({timestamp:q,coords:{latitude:0,longitude:0,accuracy:0}}),r="",f=Math.round,h=100000,m=1000,j,e,l,p,d,n,s,o=null,c=b.length;for(j=0;j<c;j++){e=b[j];l=e.coords;p=g.coords;d=e.timestamp-g.timestamp,n=l.latitude-p.latitude,s=l.longitude-p.longitude;if(f(n*h)===0&&f(s*h)===0&&j!=c-1){o=e.timestamp}else{if(o!==null&&j!=c-1){d=o-g.timestamp;r+=IntValCodec.encodeSignedNumber(f(d/m))+IntValCodec.encodeSignedNumber(0)+IntValCodec.encodeSignedNumber(0);g.timestamp=g.timestamp+f(d/m)*m;d=e.timestamp-g.timestamp;o=null}r+=IntValCodec.encodeSignedNumber(f(d/m))+IntValCodec.encodeSignedNumber(f(n*h))+IntValCodec.encodeSignedNumber(f(s*h));g=new Position({timestamp:g.timestamp+f(d/m)*m,coords:{latitude:p.latitude+f(n*h)/h,longitude:p.longitude+f(s*h)/h,accuracy:0}})}}return r}};PositionArchive.fromTks=function(g){var f=Date.parse("2000-01-01T00:00:00Z"),e=[],a=[f/1000,0,0],b=g.length,h=new PositionArchive(),c,d;while(b>0){for(c=0;c<3;c++){d=IntValCodec.decodeValueFromString(g);e[c]=a[c]+d[0];g=d[1];a[c]}h.add(new Position({timestamp:e[0]*1000,coords:{latitude:e[1]/100000,longitude:e[2]/100000,accuracy:0}}));b=g.length}return h};