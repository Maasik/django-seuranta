/* smallworldmap.js by Raphael Stefanini */
Point=(function(){function a(b,c){this.x=b;this.y=c}return a})();LatLon=(function(){var e="prototype",b=Math,g=b.cos,c=b.sin,f=b.pow,d=b.sqrt;function a(h,j){this.lat=h;this.lon=j}a[e].distance=function(k){var m=b.PI/180,j=this.lat-k.lat,l=this.lon-k.lon,h=f(c(m*j/2),2)+g(m*this.lat)*g(m*k.lat)*f(c(m*l/2),2);return 12756274*b.atan2(d(h),d(1-h))};return a})();SpheroidProjection=(function(){var h="prototype",c=Math,g=c.PI,b=180,a=6378137,f=g*a,d=g/b;function e(){}e[h].LatLonToMeters=function(j){return new Point(j.lon*a*d,c.log(c.tan((90+j.lat)*d/2))*a)},e[h].MetersToLatLon=function(j){return new LatLon((2*c.atan(c.exp(j.y/a))-g/2)/d,j.x/a/d)},e[h].resolution=function(j){return(2*f)/(256*c.pow(2,j))},e[h].zoomForPixelSize=function(j){for(i=0;i<30;i++){if(j>resolution(i)){return c.max(i-1,0)}}},e[h].pixelsToMeters=function(l,j,m){var k=resolution(m),o=l*k-f,n=j*k-f;return new Point(o,n)};return e})();SmallWorld=(function(){var b="prototype",c=Math,a=c.pow,e=function(l,m){return function(){return m.apply(l,arguments)}},d=new SpheroidProjection(),g=function(n,w,q,m,v,p,l,u,o){var t=(((p-o)*(w-v))-((q-p)*(v-u)))/(((m-l)*(w-v))-((n-m)*(v-u))),s=(((p-o)*(n-m))-((q-p)*(m-l)))/(((v-u)*(n-m))-((w-v)*(m-l))),r=q-(n*t)-(w*s);return[t,s,r]},h=function(o,l){var n=l[0],m=o[0],v=l[1],u=o[1],q=l[2],p=o[2],r=1e-15,t,s;n.x-=r;n.y+=r;v.x+=r;v.y-=r;m.x+=r;m.y+=r;u.x-=r;u.y-=r;t=g(n.x,n.y,m.x,v.x,v.y,u.x,q.x,q.y,p.x);s=g(n.x,n.y,m.y,v.x,v.y,u.y,q.x,q.y,p.y);return[t[0],t[1],t[2],s[0],s[1],s[2]]};function j(p,r,o,q,m,l){var n=[d.LatLonToMeters(o[0]),d.LatLonToMeters(o[1]),d.LatLonToMeters(o[2])],s=new Image();this.coordsToXy=h(o,n);this.xyToCoords=h(n,o);this.map_w=0;this.map_h=0;s.onload=e(this,function(){this.map_w=s.width;this.map_h=s.height;this.draw(p)});s.src=r;this.map_url=r;this.on_loaded=l||function(){};this.bg_url=q;this.overlay_img_url=m}j[b].draw=function(l){var m=$("#"+l);if(this.bg_url){m.css("background","url('"+this.bg_url+"') #cceeff")}else{m.css("background","#cceeff")}m.css("cursor","pointer");this.view_W=m.width();this.view_H=m.height();this.current_zoom=0;this.view_x=0;this.view_y=0;this.current_zoom=0;this.start_drag_x=0;this.start_drag_y=0;this.markers=[];this.routes=[];this.el=m;this.paper=Raphael(l,this.view_W,this.view_H);this.paper.rect(-10,-10,this.map_w+20,this.map_h+20).attr({fill:"#FFF"});this.map_img=this.paper.image(this.map_url,0,0,this.map_w,this.map_h);if(this.overlay_img_url){this.map_overlay=this.paper.image(this.overlay_img_url,-10,-10,this.map_w+20,this.map_h+20)}else{this.map_overlay=this.paper.rect(-10,-10,this.map_w+20,this.map_h+20).attr({fill:"#FFF",opacity:0})}this.map_overlay.drag(e(this,function(p,o,n,q){this.el.css("cursor","move");this.view_x=this.start_drag_x-p/a(2,this.current_zoom);this.view_y=this.start_drag_y-o/a(2,this.current_zoom);this.paper.setViewBox(this.view_x,this.view_y,this.view_W,this.view_H,false)}),e(this,function(n,o){this.start_drag_x=this.view_x;this.start_drag_y=this.view_y}),e(this,function(n,o){this.el.css("cursor","pointer")}));$(window).bind("resize",e(this,j[b]._on_resize));this.on_loaded()};j[b]._on_resize=function(){this.paper.setSize(this.el.width(),this.el.height());this._on_zoom()};j[b].zoom_in=function(){this.view_x+=this.el.width()/a(2,this.current_zoom)/4;this.view_y+=this.el.height()/a(2,this.current_zoom)/4;this.current_zoom++;this._on_zoom()};j[b].zoom_out=function(){this.current_zoom--;this.view_x-=this.el.width()/a(2,this.current_zoom)/4;this.view_y-=this.el.height()/a(2,this.current_zoom)/4;this._on_zoom()};j[b]._on_zoom=function(){this.view_W=this.el.width()/a(2,this.current_zoom);this.view_H=this.el.height()/a(2,this.current_zoom);this.paper.setViewBox(this.view_x,this.view_y,this.view_W,this.view_H,false);for(i=0;i<this.markers.length;i++){this.markers[i]._redraw()}};j[b].LatLonToMapXY=function(n){var m=d.LatLonToMeters(n),l=m.x*this.coordsToXy[0]+m.y*this.coordsToXy[1]+this.coordsToXy[2],o=m.x*this.coordsToXy[3]+m.y*this.coordsToXy[4]+this.coordsToXy[5];return new Point(l,o)};j[b].MapXYToLatLon=function(m){var l,n;l=m.x*this.xyToCoords[0]+m.y*this.xyToCoords[1]+this.xyToCoords[2];n=m.x*this.xyToCoords[3]+m.y*this.xyToCoords[4]+this.xyToCoords[5];return d.MetersToLatLon(new Point(l,n))};j[b].ViewPortXYToLatLon=function(m){var l,n;l=(m.x/a(2,this.current_zoom)+this.view_x);n=(m.y/a(2,this.current_zoom)+this.view_y);return this.MapXYToLatLon(new Point(l,n))};j[b].center=function(l){var m=this.LatLonToMapXY(l);this.view_x=m.x-this.view_W/2;this.view_y=m.y-this.view_H/2;this.paper.setViewBox(this.view_x,this.view_y,this.view_W,this.view_H,false)};function k(m,l,n){this.latlon=m;this.color=l||"#09F";this.text=n||"";this.size=9}k[b].draw=function(m){var l=m.LatLonToMapXY(this.latlon),n=this.color;this.map=m;this.circle=m.paper.circle(l.x,l.y,this.size).attr({stroke:n,opacity:0.75,"stroke-width":4});this.name=m.paper.text(l.x+13,l.y+13,this.text).attr({"font-size":"20px",fill:n,stroke:n,"text-anchor":"start"});m.markers.push(this);m.map_overlay.toFront()};k[b].move=function(l){this.latlon=l;this._redraw()};k[b]._redraw=function(){var m=this.map.LatLonToMapXY(this.latlon),l=a(2,this.map.current_zoom);this.circle.attr({cx:m.x,cy:m.y,r:this.size/l});this.name.attr({x:m.x+15/l,y:m.y+15/l,"font-size":(20/l)+"px"})};k[b].show=function(l){this.name.show();this.circle.show()};k[b].hide=function(l){this.name.hide();this.circle.hide()};function f(m,l){this.coords=m;this.color=l||"#09F";this.width=4}f[b].draw=function(o){this.map=o;var m="M",l,n;for(l=0;l<this.coords.length;l++){if(l>0){m+="L"}n=o.LatLonToMapXY(this.coords[l]);m+=[n.x,n.y].join(" ")}this.path=o.paper.path(m).attr({stroke:this.color,opacity:0.75,"stroke-width":this.width,"stroke-linejoin":"round"});o.routes.push(this);o.map_overlay.toFront()};f[b].set_new_path=function(m){var l="M",n;this.coords=m;for(i=0;i<m.length;i++){if(i>0){l+="L"}n=this.map.LatLonToMapXY(m[i]);l+=[n.x,n.y].join(" ");this.path.attr({path:l})}};f[b].show=function(l){this.path.show()};f[b].hide=function(l){this.path.hide()};return{Map:j,Marker:k,Route:f}})();