{% extends "base.html" %}
{% load i18n %}
{% load tz %}

{% block content %}
<h2><i class="fa fa-trophy"></i> {% trans "Your Events"%}</h2>
<div>
	{% if  user.competitions.all.count %}
	<table class="table table-striped">
	    <thead>
	        <tr>
    	        <th>{% trans "Name" %}</th>
    	        <th>{% trans "Privacy" %}</th>
                <th>{% trans "Period" %}</th>
                <th>{% trans "Actions" %}</th>
            </tr>
	    </thead>
        <tbody>
        {% for c in user.competitions.all %}
        {% timezone c.timezone %}
        <tr>
	        <td>{{c.name}}</td>
	        <td>{{c.get_publication_policy_display}}</td>
	        <td>{{c.opening_date}} - {{c.closing_date}}<br/> in {{c.timezone}} {% trans 'Timezone' %}</td>
    		<td>
    		<a title="{% trans "Competitors" %}" class="btn btn-info" href="?id={{c.uuid}}&view=trackers" ><i class="fa fa-users"></i></a>
    		<a title="{% trans "View" %}" class="btn btn-info" href="{{ c.absolute_url }}"><i class="fa fa-search"></i></a>
	         - <a title="{% trans "Delete" %}" class="btn btn-danger btn_delete_race" data-race-id="{{c.uuid}}" href="#"><i class="fa fa-trash-o"></i></a>
            </td>
        </tr>
    {% endtimezone %}
        {% endfor %}
        </tbody>
	</table>
    {% else %}
    <span>{% trans "You don't have any competition yet!"%}</span>
    {% endif %}
</div>
<form style='display:hidden' action="" method="post">
{% csrf_token %}
</form>
{% endblock %}

{% block extra_scripts %}
<script>
    $(function(){
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        var onPressDeleteLink = function(e){
            e.preventDefault();
            var el = $(this),
                race_uuid = el.attr("data-race-id");
            if(confirm("{% trans "Are you sure you want to delete this race?"%}")){
                el.html('<i class="fa fa-spinner fa-spin"></i>');
                $.ajax({
                    type:"POST",
                    url:'{% url 'seuranta_dashboard' %}?id='+race_uuid,
                    data:{'action':'delete'},
                    dataType:"json",
                    beforeSend: function(xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }).done(function(result) {
                    if(result.status=="OK"){
                        el.parent().parent().hide();
                        alert(result.msg);
                        window.location.reload();
                    }else{
                        alert("{% trans 'Something went wrong...' %}");
                    }
                })
                .fail(function(jqXHR, textStatus) {
                    window.location.reload();
                })
                .always(function(r) {
                    el.html('<i class="fa fa-trash-o"></i>');
                });
            }
        }
        $.each(
            $(".btn_delete_race"),
            function(i, btn){
                $(btn).on('click', onPressDeleteLink);
            }
        );
    });
</script>
{% endblock %}
